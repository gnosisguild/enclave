---
title: 'Ciphernode Operators'
description: 'How to bond, configure, and operate Ciphernodes on the Enclave network'
---

# Ciphernode Operators

Ciphernodes are the distributed workers that decrypt committee outputs, publish threshold key
shares, and keep the Enclave network alive. This guide walks through the economic requirements,
on-chain lifecycle, CLI workflow, networking expectations, and production deployment patterns for
running a Ciphernode.

## Role overview

Ciphernodes are expected to:

- Maintain an online endpoint and participate in the event bus
- Bond license collateral (ENCL) and hold tickets (stablecoin-backed ETK) to earn committee slots
- Submit tickets on-chain during sortition and publish committee key material
- Produce decryption shares for every E3 the node was selected to serve
- Remain slash-aware: missed duties or malicious behavior can lose both ticket collateral and
  license bonds

The protocol is chain-agnostic. Each configured chain entry in `enclave.config.yaml` can track a
different Enclave + registry deployment, and each Ciphernode instance manages the lifecycle for its
configured chains simultaneously.

## Contract references

| Contract                 | Sepolia address                              | Notes                            |
| ------------------------ | -------------------------------------------- | -------------------------------- |
| Enclave                  | `0x1E8BD97F15Cd94f250a4dd567d2fd2114303FAa6` | Core coordinator                 |
| CiphernodeRegistry       | `0x11F647479bEd47cd0dd10276DDc04F2d4B20b1C7` | Handles registration, committees |
| BondingRegistry          | `0x56368bB545Ab2D6811b4dffa8Ad4B8AF560406E3` | Tracks license bonds + tickets   |
| SlashingManager          | `0x50dfC643226f09423d51F81c7f37F7a5F1e8f359` | Slash + ban workflow             |
| EnclaveTicketToken (ETK) | `0x72691272E10a8CA6499c3aa0d59c76E4C090c9E2` | Ticket wrapper around USDC       |
| EnclaveToken (ENCL)      | `0xc93f71D10874F09F7F514a3d160E5be21fD624ab` | License bond token               |
| MockUSDC (fee token)     | `0xB58B762748c64f1a36B34012d1C52503617f4De0` | Underlying asset for ETK         |

> ⚠️ Always confirm the latest addresses from the docs. Addresses differ per network.

## Economics & staking

BondingRegistry constants on Sepolia:

- **Ticket price**: `10_000_000` base units (10 USDC per ticket)
- **License bond requirement**: `100 ENCL`
- **Active license floor**: 80% of the required bond must remain bonded
- **Minimum ticket balance**: 1 ticket (10 USDC)
- **Exit delay**: `604_800 s` (7 days)

Ticket balances are represented by the non-transferable `EnclaveTicketToken`. To mint tickets:

1. Acquire the underlying stablecoin (`MockUSDC` on Sepolia)
2. Approve the BondingRegistry to pull funds
3. Call `addTicketBalance(amount)`

The number of usable tickets is:

```
availableTickets = floor(ticketTokenBalance / ticketPrice)
```

Tickets control a node's probability of selection via sortition.

License bonds are denominated in ENCL. Operators must keep at least 80% of `licenseRequiredBond`
bonded to remain `active`.

SlashingManager penalties can remove both ticket balances and license bonds, and may ban an
operator. Appeals are time-bound by the policy's `appealWindow`.

Rewards (any ERC20) are pushed by the configured `rewardDistributor` through
`BondingRegistry.distributeRewards`. Only registered operators receive payouts.

## Lifecycle checklist

1. **Acquire collateral**
   - ENCL for license bonding
   - USDC (or the configured fee token) for tickets
2. **Bond the license**
   ```bash
   cast send $BONDING "bondLicense(uint256)" 100e18 --private-key $OPERATOR_KEY --rpc-url $RPC
   ```
3. **Register as a ciphernode**
   ```bash
   cast send $BONDING "registerOperator()" --private-key $OPERATOR_KEY --rpc-url $RPC
   ```
4. **Deposit tickets**
   ```bash
   cast send $FEE_TOKEN "approve(address,uint256)" $BONDING 1000e6 --rpc-url $RPC --private-key $OPERATOR_KEY
   cast send $BONDING "addTicketBalance(uint256)" 1000e6 --rpc-url $RPC --private-key $OPERATOR_KEY
   ```
5. **Verify status**
   - `BondingRegistry.isRegistered(address)` must be `true`
   - `BondingRegistry.isActive(address)` turns `true` after ticket + license thresholds
6. **Stay online**
   - Run the CLI (see below) so your node listens for events and participates in sortition
7. **Handle exits**
   - Call `deregisterOperator(siblingProof)` to begin exit
   - Wait 7 days, then `claimExits(maxTickets, maxLicense)` to withdraw

> ℹ️ The sibling proof passed to `deregisterOperator` is the path needed to remove the node from the
> registry IMT. Capture it from the Merkle proof emitted in `CiphernodeAdded` events or by querying
> the registry before exit.

## CLI workflow

The `enclave` CLI wraps node orchestration, credentials, and repository tooling.

### Initialize configuration

```bash
enclave config-set --rpc-url $RPC --eth-address $OPERATOR_ADDRESS
```

This creates `~/.config/enclave/config.yaml` (or the path you pass with `--config`). Most operators
instead commit an `enclave.config.yaml` alongside deployment manifests (see sample below) and pass
it with `--config /path/to/config.yaml` on every command.

### Manage credentials

| Secret                                   | Command                                                                       | Notes                                              |
| ---------------------------------------- | ----------------------------------------------------------------------------- | -------------------------------------------------- |
| Password (encrypts keystore + datastore) | `enclave password set --password <value>`                                     | Use `enclave password delete` to remove            |
| Network key (libp2p ed25519)             | `enclave net keypair generate` or `enclave net keypair set --net-keypair 0x…` | `enclave net peer-id purge` clears cached peer IDs |
| Wallet key (signs on-chain tx)           | `enclave wallet set --private-key 0x…`                                        | Needed for the node to submit on-chain txs         |

The entrypoint automatically runs `autopassword`, `autonetkey`, and `autowallet` when the config
sets those flags.

### Run nodes

```bash
enclave nodes up --detach               # start every node profile defined in config
enclave nodes ps                        # list process status
enclave nodes status cn1                # query single node
enclave nodes restart cn1               # restart one node
enclave nodes down                      # stop everything
enclave nodes purge                     # wipe local db + secrets (irreversible)
```

To run a single node profile outside the supervisor, use
`enclave start --config /path/to/config.yaml`. Pass peers with
`--peer /dns4/bootstrap.enclave.gg/udp/5901/quic-v1` to override the config at runtime.

## Networking & configuration

Every node section in `enclave.config.yaml` defines how the CLI spawns that instance:

```yaml
node:
  address: '0x7099…79C8'
  quic_port: 9201
  peers:
    - '/dns4/bootstrap.enclave.gg/udp/5901/quic-v1'
  autonetkey: true
  autopassword: true
chains:
  - name: sepolia
    rpc_url: 'wss://ethereum-sepolia.publicnode.com'
    contracts:
      enclave:
        address: '0x1E8B…FAa6'
        deploy_block: 9615399
      ciphernode_registry:
        address: '0x11F6…0b1C7'
      bonding_registry:
        address: '0x5636…406E3'
      fee_token:
        address: '0xB58B…4De0'
```

Notes:

- `peers` expects libp2p multiaddrs (`/dns4/<host>/udp/<port>/quic-v1`). Provide at least one
  bootstrap peer. For production, run a static bootstrap service (planned: `bootstrap.enclave.gg`).
- `quic_port` must match firewall rules; expose UDP.
- Each node can override `data_dir` and `config_dir` if the defaults under `~/.local/share/enclave`
  and `~/.config/enclave` are unsuitable.
- Set `role.type: aggregator` for nodes tasked with publishing plaintext outputs.

## Deployment manifests & secrets

The repository ships a Docker Swarm example under `deploy/` that you can adapt:

- `cn*.yaml` / `agg.yaml`: minimal configs templated with `${ADDRESS}` and `${RPC_URL}`
- `docker-compose.yml`: runs multiple Ciphernodes plus an aggregator with shared overlay network
- Secrets files (`cn1.secrets.json`, etc.) follow:
  ```json
  {
    "password": "changeme",
    "private_key": "0x…",
    "network_private_key": "0x…"
  }
  ```
- `ciphernode-entrypoint.sh` loads the config + secrets, runs the CLI commands
  (`enclave password set`, `enclave net keypair set`, `enclave wallet set`), then execs
  `enclave start -v`

This pattern is also useful for Kubernetes Jobs or systemd units: mount a config, mount an encrypted
secret bundle, run the entrypoint.

## Sortition & operations

- Committee requests originate from the Enclave contract. The registry snapshots ticket balances at
  `requestBlock - 1`, so topping up tickets after a request starts will not help that round.
- Submission window defaults to 10 seconds on Sepolia (`sortitionSubmissionWindow`). Nodes must call
  `submitTicket(e3Id, ticketNumber)` before it expires. The CLI handles this automatically using the
  event bus.
- `finalizeCommittee` can be called by anyone once the window closes and at least `threshold_m`
  submissions exist. After finalization, nodes publish key shares, aggregate the public key, and
  submit it via `publishCommittee`.
- If a node is offline during submission, it misses the round but remains active provided its stake
  satisfies the requirements. Repeated failures risk slashing.

## Rewards, slashing, and exits

- **Rewards**: Watch for `RewardDistributed` (BondingRegistry) logs. Ensure the operator wallet can
  receive the reward token.
- **Slashing**: `SlashingManager` proposals reference reason codes. Operators should monitor
  `SlashProposed` and be ready to file `fileAppeal()` before `appealWindow` expires when proof is
  not required. Banned nodes cannot reregister until governance clears them via `updateBanStatus`.
- **Exits**: `deregisterOperator()` burns tickets immediately and queues withdrawals. The exit queue
  tracks amounts per operator; call `pendingExits(address)` or `previewClaimable(address)` to view
  status.

## Troubleshooting

| Symptom                           | Checks                                                                                                                       |
| --------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| `enclave start` exits immediately | Ensure `enclave config-set` ran or `--config` points to a file. Missing configs trigger auto-init.                           |
| Node never `isActive`             | Confirm you bonded `>= 80` ENCL, deposited at least 1 ticket, and were not banned/slashed.                                   |
| Cannot connect to peers           | Open UDP `quic_port`, provide working multiaddrs, and consider `enclave start --peer …` to override.                         |
| Sortition submissions fail        | Node must be registered + active _before_ `Enclave.request`. Inspect logs for `NodeNotEligible` or `SubmissionWindowClosed`. |
| `ExitNotReady` on `claimExits`    | Wait until `block.timestamp >= exitUnlocksAt` plus the queued delay. Use `previewClaimable`.                                 |
| Slashing appeal rejected          | Review `SlashPolicy` for that reason—policies requiring proofs skip appeals.                                                 |

Maintaining high uptime, redundant networking, and alerting on contract events are the best ways to
protect your stake. Use the CLI supervisors plus infrastructure automation to ensure secrets and
configs stay consistent across restarts.
